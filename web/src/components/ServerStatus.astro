---
/**
 * Server Status widget - fetches real-time data from mcstatus.io API
 * Client-side component for live updates
 */
interface Props {
  serverAddress?: string;
  compact?: boolean;
}

const { serverAddress = 'play.bhsmp.com', compact = false } = Astro.props;
---

<div
  id="server-status"
  class:list={[
    'rounded-xl bg-secondary-stone/10 border border-secondary-stone/30',
    compact ? 'p-3' : 'p-4',
  ]}
  data-server={serverAddress}
>
  <div class="flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <!-- Status indicator -->
      <div
        id="status-indicator"
        class="w-3 h-3 rounded-full bg-secondary-stone animate-pulse"
        title="Checking..."
      ></div>

      <div>
        <div class="flex items-center gap-2">
          <span id="status-text" class="font-medium text-text-light text-sm">
            Checking...
          </span>
        </div>
        {!compact && (
          <p id="player-count" class="text-xs text-text-light/70 mt-0.5">
            Loading player count...
          </p>
        )}
      </div>
    </div>

    <!-- Copy IP button -->
    <button
      id="copy-ip-btn"
      class="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-text-light/80 hover:text-primary-gold bg-secondary-stone/30 hover:bg-secondary-stone/40 rounded-lg transition-colors"
      data-ip={serverAddress}
      title="Copy server IP"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <span id="copy-text">Copy IP</span>
    </button>
  </div>

  {!compact && (
    <div id="server-version" class="mt-3 pt-3 border-t border-secondary-stone/30 text-xs text-text-light/70">
      <span>Version: </span>
      <span id="version-text">Loading...</span>
    </div>
  )}
</div>

<script>
  interface ServerStatusResponse {
    online: boolean;
    players?: {
      online: number;
      max: number;
    };
    version?: {
      name_clean: string;
    };
  }

  const CACHE_KEY = 'server-status-cache';
  const CACHE_DURATION = 30000; // 30 seconds

  async function fetchServerStatus(serverAddress: string): Promise<ServerStatusResponse | null> {
    // Check cache first
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      const { data, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp < CACHE_DURATION) {
        return data;
      }
    }

    try {
      const response = await fetch(
        `https://api.mcstatus.io/v2/status/java/${serverAddress}`
      );

      if (!response.ok) {
        throw new Error('Failed to fetch status');
      }

      const data = await response.json();

      // Cache the result
      localStorage.setItem(
        CACHE_KEY,
        JSON.stringify({ data, timestamp: Date.now() })
      );

      return data;
    } catch (error) {
      console.error('Error fetching server status:', error);
      return null;
    }
  }

  function updateUI(status: ServerStatusResponse | null) {
    const indicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const playerCount = document.getElementById('player-count');
    const versionText = document.getElementById('version-text');

    if (!indicator || !statusText) return;

    if (status?.online) {
      indicator.className = 'w-3 h-3 rounded-full bg-primary-gold';
      indicator.title = 'Server Online';
      statusText.textContent = 'Online';
      statusText.className = 'font-medium text-primary-gold text-sm';

      if (playerCount && status.players) {
        playerCount.textContent = `${status.players.online}/${status.players.max} players`;
      }

      if (versionText && status.version) {
        versionText.textContent = status.version.name_clean || 'Unknown';
      }
    } else {
      indicator.className = 'w-3 h-3 rounded-full bg-accent-redstone';
      indicator.title = 'Server Offline';
      statusText.textContent = 'Offline';
      statusText.className = 'font-medium text-accent-redstone/90 text-sm';

      if (playerCount) {
        playerCount.textContent = 'Server is currently offline';
      }

      if (versionText) {
        versionText.textContent = 'N/A';
      }
    }
  }

  // Copy IP functionality
  const copyBtn = document.getElementById('copy-ip-btn');
  const copyText = document.getElementById('copy-text');

  copyBtn?.addEventListener('click', async () => {
    const ip = copyBtn.getAttribute('data-ip');
    if (ip && copyText) {
      try {
        await navigator.clipboard.writeText(ip);
        copyText.textContent = 'Copied!';
        setTimeout(() => {
          copyText.textContent = 'Copy IP';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }
  });

  // Fetch status on load
  const serverStatus = document.getElementById('server-status');
  const serverAddress = serverStatus?.getAttribute('data-server') || 'play.bhsmp.com';

  fetchServerStatus(serverAddress).then(updateUI);

  // Refresh every 30 seconds
  setInterval(() => {
    // Clear cache to force refresh
    localStorage.removeItem(CACHE_KEY);
    fetchServerStatus(serverAddress).then(updateUI);
  }, CACHE_DURATION);
</script>
