services:
  minecraft:
    image: itzg/minecraft-server:latest
    container_name: blockhaven-mc
    restart: unless-stopped
    tty: true
    stdin_open: true

    ports:
      - "25565:25565"      # Java Edition
      - "19132:19132/udp"  # Bedrock Edition (Geyser)

    environment:
      # Server Type
      TYPE: PAPER
      VERSION: "1.21.11"  # Latest stable Paper version (Jan 2026)
      EULA: "TRUE"

      # Memory Settings (6GB for 8GB VPS, leave headroom)
      MEMORY: "6G"
      JVM_XX_OPTS: "-XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1"

      # Server Properties
      SERVER_NAME: "BlockHaven"
      MOTD: "§a§lBlockHaven §r§b - play.bhsmp.com §7|| §bMinecraft & Chill!\n§aSMP & Creative §7| §aEconomy §7| §aLand Claims §7| §aNo Griefing §b☻"
      OVERRIDE_ICON: "TRUE"
      OVERRIDE_SERVER_PROPERTIES: "TRUE"
      LEVEL: "spawn"
      MAX_PLAYERS: 50
      DIFFICULTY: normal
      MODE: survival
      PVP: "false"
      ONLINE_MODE: "true"
      ENFORCE_SECURE_PROFILE: "true"
      SPAWN_PROTECTION: 16
      VIEW_DISTANCE: 10
      SIMULATION_DISTANCE: 8
      MAX_WORLD_SIZE: 10000

      # Whitelist (invite-only server)
      ENABLE_WHITELIST: "true"
      # Note: Bedrock/Xbox players via Floodgate have usernames starting with "."
      WHITELIST: "PrLLager207"

      # RCON for remote management
      ENABLE_RCON: "true"
      RCON_PASSWORD: "${RCON_PASSWORD}"
      RCON_PORT: 25575

      # Ops
      OPS: "${SERVER_OPS}"

      # Plugins from local repo (reliable, version-controlled)
      # Copies JARs from mounted /plugins-local to /data/plugins on startup
      COPY_PLUGINS_SRC: /plugins-local
      COPY_PLUGINS_DEST: /data/plugins

      # Only download plugins not in our local collection
      MODRINTH_PROJECTS: multiverse-core,multiverse-portals,multiverse-netherportals,voidgen
      PLUGINS: |
        https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/spigot
        https://download.geysermc.org/v2/projects/floodgate/versions/latest/builds/latest/downloads/spigot
        https://hangar.papermc.io/api/v1/projects/ViaVersion/versions/5.7.0/PAPER/download

      # Timezone
      TZ: "America/New_York"

    volumes:
      - blockhaven-mc-data:/data
      - ./plugins/downloaded_installers:/plugins-local:ro
      - ./extras:/extras:ro
      - ./extras/server-icon.png:/data/server-icon.png:ro

    healthcheck:
      test: mc-health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    labels:
      - "com.centurylinklabs.watchtower.enable=false"

volumes:
  blockhaven-mc-data:
    driver: local
