# Local Development / Family LAN Server
# Usage: docker compose -f docker-compose.local.yml up -d
#
# This is a simplified version for local play with family.
# Uses a named volume for data persistence (same as VPS).
#
# To import data from VPS, see: docs/LOCAL-SETUP.md

services:
  minecraft:
    image: itzg/minecraft-server:latest
    container_name: blockhaven-local
    restart: unless-stopped
    tty: true
    stdin_open: true

    ports:
      - "25565:25565"      # Java Edition
      - "19132:19132/udp"  # Bedrock Edition (Geyser)

    environment:
      # Server Type
      TYPE: PAPER
      VERSION: "1.21.11"
      EULA: "TRUE"

      # Memory Settings (adjust based on your machine)
      # 4GB is good for family play, increase if you have more RAM
      MEMORY: "4G"
      JVM_XX_OPTS: "-XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200"

      # Server Properties
      SERVER_NAME: "BlockHaven Home"
      MOTD: "§a§lBlockHaven Home §7|| §bPrill Family Server\n§aSMP & Creative §7| §aEconomy §7| §aLand Claims §7| §aNo Griefing §b☻"
      OVERRIDE_ICON: "TRUE"
      OVERRIDE_SERVER_PROPERTIES: "TRUE"
      LEVEL: "spawn"
      MAX_PLAYERS: 20
      DIFFICULTY: normal
      MODE: survival
      PVP: "false"
      ONLINE_MODE: "true"
      ENFORCE_SECURE_PROFILE: "true"
      SPAWN_PROTECTION: 16
      VIEW_DISTANCE: 12
      SIMULATION_DISTANCE: 10
      MAX_WORLD_SIZE: 10000

      # Ops
      OPS: "PrLLager207"

      # RCON for management
      ENABLE_RCON: "true"
      RCON_PASSWORD: "localdev"
      RCON_PORT: 25575

      # Plugins from local repo (reliable, version-controlled)
      # Copies JARs from mounted /plugins-local to /data/plugins on startup
      COPY_PLUGINS_SRC: /plugins-local
      COPY_PLUGINS_DEST: /data/plugins

      # Only download plugins not in our local collection
      MODRINTH_PROJECTS: multiverse-core,multiverse-portals,multiverse-netherportals,voidgen
      PLUGINS: |
        https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/spigot
        https://download.geysermc.org/v2/projects/floodgate/versions/latest/builds/latest/downloads/spigot
        https://hangar.papermc.io/api/v1/projects/ViaVersion/versions/5.7.0/PAPER/download

      # Timezone
      TZ: "America/New_York"

    volumes:
      - blockhaven-local-data:/data
      - ./plugins/downloaded_installers:/plugins-local:ro
      - ./extras:/extras:ro
      - ./extras/server-icon.png:/data/server-icon.png:ro
      # Plugin configs from repo (version-controlled)
      - ./plugins/configs:/plugin-configs:ro
      - ./scripts/copy-plugin-configs.sh:/copy-plugin-configs.sh:ro

    # Run config copy script before starting the server
    command: >-
      sh -c "/copy-plugin-configs.sh && /start"

    healthcheck:
      test: mc-health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  blockhaven-local-data:
    driver: local
